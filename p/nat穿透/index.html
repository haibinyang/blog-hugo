<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="NAT NAT traversal NAT实现方式 1）静态NAT 2）NAPT NAT的主要类型 Full Cone 内部机器Client访问外网机器C，NAT打开一个端口，后面外网的任意ip"><title>NAT穿透</title>
<link rel=canonical href=https://blog.ververv.com/p/nat%E7%A9%BF%E9%80%8F/><link rel=stylesheet href=/scss/style.min.d8118f156935b64eca93aca758476adca858d2c47354971654d9bd2933a0e45f.css><meta property='og:title' content="NAT穿透"><meta property='og:description' content="NAT NAT traversal NAT实现方式 1）静态NAT 2）NAPT NAT的主要类型 Full Cone 内部机器Client访问外网机器C，NAT打开一个端口，后面外网的任意ip"><meta property='og:url' content='https://blog.ververv.com/p/nat%E7%A9%BF%E9%80%8F/'><meta property='og:site_name' content='量子跳跃者'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:published_time' content='2020-03-13T07:58:58+08:00'><meta property='article:modified_time' content='2020-03-13T07:58:58+08:00'><meta name=twitter:title content="NAT穿透"><meta name=twitter:description content="NAT NAT traversal NAT实现方式 1）静态NAT 2）NAPT NAT的主要类型 Full Cone 内部机器Client访问外网机器C，NAT打开一个端口，后面外网的任意ip"><link rel="shortcut icon" href=/favicon.png><script defer src=https://analytics.ververv.com/pixel/tABAb34VvSTV05V2></script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky compact"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><div class=site-meta><h1 class=site-name><a href=/>量子跳跃者</a></h1><h2 class=site-description></h2></div></header><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li><a href=/links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg>
<span>Links</span></a></li><li><a href=/ target=_blank><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li class=menu-bottom-section><ol class=menu><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">目录</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#nat>NAT</a><ol><li><a href=#nat实现方式>NAT实现方式</a></li><li><a href=#nat的主要类型>NAT的主要类型</a><ol><li><a href=#full-cone>Full Cone</a></li><li><a href=#address-restricted-cone>Address Restricted Cone</a></li><li><a href=#port-restricted-cone>Port Restricted Cone</a></li><li><a href=#symmetric>Symmetric</a></li></ol></li></ol></li><li><a href=#nat穿越技术>NAT穿越技术</a><ol><li><a href=#应用场景>应用场景</a></li><li><a href=#udp打洞算法>UDP打洞算法</a></li><li><a href=#tpc遇到的问题>TPC遇到的问题</a></li><li><a href=#tcp打洞-todo>TCP打洞-TODO</a></li></ol></li><li><a href=#stun原理>STUN原理</a><ol><li><a href=#step1>STEP1</a></li><li><a href=#step2>STEP2</a></li><li><a href=#step3>STEP3</a></li><li><a href=#step4>STEP4</a></li></ol></li><li><a href=#实现>实现</a></li><li><a href=#其它>其它</a></li><li><a href=#参考>参考</a></li></ol></nav></div></section></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/nat-traversal-network/>Nat Traversal Network</a></header><div class=article-title-wrapper><h2 class=article-title><a href=/p/nat%E7%A9%BF%E9%80%8F/>NAT穿透</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Mar 13, 2020</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 5 分钟</time></div></footer></div></header><section class=article-content><h2 id=nat>NAT</h2><blockquote><p>NAT traversal</p></blockquote><h3 id=nat实现方式>NAT实现方式</h3><p>1）静态NAT</p><img src=https://blog-10039692.file.myqcloud.com/1505808407153_9340_1505808407349.png alt=img style=zoom:50%><p>2）NAPT</p><img src=https://blog-10039692.file.myqcloud.com/1505808416923_4531_1505808417110.png alt=img style=zoom:50%><h3 id=nat的主要类型>NAT的主要类型</h3><h4 id=full-cone>Full Cone</h4><p>内部机器Client访问外网机器C，NAT打开一个端口，后面外网的任意ip和任意port都可以访问这个端口，也就是任意ip+任意port可以访问机器Client。</p><img src=https://blog-10039692.file.myqcloud.com/1505808434127_6861_1505808434549.png alt=img style=zoom:25%><h4 id=address-restricted-cone>Address Restricted Cone</h4><p>内部机器Client访问外网机器A，NAT打开一个端口，后面机器A的任意port可以访问这个端口，就是只能固定ip+任意port访问Client。</p><img src=https://blog-10039692.file.myqcloud.com/1505808448549_1177_1505808449018.png alt=img style=zoom:25%><h4 id=port-restricted-cone>Port Restricted Cone</h4><p>内部机器Client访问外网机器A，NAT打开一个端口，后面机器A的固定port可以访问这个端口，就是只能固定ip+固定port访问Client。</p><img src=https://blog-10039692.file.myqcloud.com/1505808448549_1177_1505808449018.png alt=img style=zoom:25%><h4 id=symmetric>Symmetric</h4><p>连接不同的外部Server，NAT打开的端口会变化。也就是内部机器Client连接外网机器A时，NAT会打开一个端口，连接外网机器B时又会打开另外一个端口。</p><img src=https://blog-10039692.file.myqcloud.com/1505808476505_6782_1505808476983.png alt=img style=zoom:25%><h2 id=nat穿越技术>NAT穿越技术</h2><ol><li>UPnP，把NAT端口（对外）映射到UPnP端口，再由UPnP程序处理（我们自己写的符合UPnP程序）。迅雷，电骡基于这个方式实现。需要操作系统支持UPnP。</li><li>ALG(应用层网关),如同一个NAT的插件，让NAT能识别插入的协议从而避免打洞。确定是需要系统支持插入的协议，比如，FTP，SIP，DNS等。</li><li>STUN/TURN/ICE，相比上面2者</li></ol><ul><li>SBC：？？TODO</li></ul><h3 id=应用场景>应用场景</h3><ul><li>对等网络</li><li>VoIP领域</li><li>网络视频监控</li></ul><h3 id=udp打洞算法>UDP打洞算法</h3><blockquote><p>英文名：UDP hole punching</p></blockquote><p>假设有两台分别处于各自的私有网络中的主机：A和B；N1和N2是两个网络的NAT设备，分别拥有IP地址P1和P2；S是一个使用了一个众所周知的、从全球任何地方都能访问得到的IP地址的公共服务器</p><ol><li>A和B分别和S建立UDP连接；NAT设备N1和N2创建UDP转换状态并分配临时的外部端口号</li><li>S检查UDP包，看A和B的端口是否是正在被使用的（否则的话N1和N2应该是应用了端口随机分配，这会让路由验证变得更麻烦）</li><li>如果端口不是随机化的，那么A和B各自选择端口X和Y，并告知S。S会让A发送UDP包到P2:Y，让B发送UDP包到P1:X</li><li>A和B通过转换好的IP地址和端口直接联系到对方的NAT设备；</li></ol><p><a class=link href=https://zh.wikipedia.org/wiki/UDP%E6%89%93%E6%B4%9E target=_blank rel=noopener>参考</a></p><h3 id=tpc遇到的问题>TPC遇到的问题</h3><p>TCP和UDP在打洞上不同，这是因为伯克利socket的API造成的：UDP的socket允许多个socket绑定到同一个本地端口，而TCP的socket则不允许。</p><ol><li>A B要连接到S，肯定首先A B双方都会在本地创建一个socket，去连接S上的socket。创建一个socket必然会绑定一个本地端口。（假设为8888，这样A和B才分别建立了到 S的通信信道）</li><li>接下来就需要打洞了，打洞则需要A和B分别发送数据包到对方的公网IP。但是问题就在这里，因为NAT设备是根据端口号来确定session，</li></ol><ul><li>如果是UDP的socket，A B可以分别再创建socket，然后将socket绑定到8888，这样打洞就成功了。</li><li>但是如果是TCP的socket，则不能再创建socket并绑定到8888了，这样打洞就无法成功。</li></ul><p>TODO：还是不明白</p><p><a class=link href=https://juejin.im/entry/5b5d9232f265da0f9f4e7448 target=_blank rel=noopener>参考</a></p><h3 id=tcp打洞-todo>TCP打洞-TODO</h3><p><a class=link href=http://www.52im.net/thread-542-1-1.html target=_blank rel=noopener>链接：非常好的文章</a></p><p><a class=link href=https://en.wikipedia.org/wiki/TCP_hole_punching target=_blank rel=noopener>Wiki</a></p><h2 id=stun原理>STUN原理</h2><p>假设有如下UAC（B），NAT（A），SERVER（C）。</p><p>UAC的IP为IPB，NAT的IP为 IPA ，SERVER的 IP为IPC1 、IPC2。请注意，服务器C有两个IP。</p><h3 id=step1>STEP1</h3><p>B向C的IP1的pot1端口发送一个UDP 包。C收到这个包后，会把它收到包的源IP和port写到UDP包中，然后把此包通过IP1和port1发还给B。</p><p>当B收到此UDP后，把此UDP中的IP和自己的IP做比较，如果是一样的，就说明自己是在公网。</p><h3 id=step2>STEP2</h3><p>B向C的IP1发送一个UDP包，请求C通过另外一个IP2和PORT（不同与SETP1的IP1）向B返回一个UDP数据包。</p><p>如果B收到了这个数据包，那说明什么？说明NAT来着不拒，不对数据包进行任何过滤，这也就是STUN标准中的full cone NAT。</p><h3 id=step3>STEP3</h3><p>B向C的IP2的port2发送一个数据包，C收到数据包后，把它收到包的源IP和port写到UDP包中，然后通过自己的IP2和port2把此包发还给B。</p><p>如果这个port和step1中的port一样，那么可以肯定这个NAT是个CONE NAT，否则是对称NAT。</p><blockquote><p>道理很简单：根据对称NAT的规则，当目的地址的IP和port有任何一个改变，那么NAT都会重新分配一个port使用。</p><p>而在step3中，和step1对应，我们改变了IP和port。因此，如果是对称NAT,那这两个port肯定是不同的。</p></blockquote><h3 id=step4>STEP4</h3><p>B向C的IP2的一个端口PD发送一个数据请求包，要求C用IP2和不同于PD的port返回一个数据包给B。</p><p>如果B收到了，那也就意味着只要IP相同，即使port不同，NAT也允许UDP包通过。显然这是restrict cone NAT。如果没收到，那就是port restrict NAT.。</p><p><a class=link href=https://blog.csdn.net/rudyn/article/details/25232303 target=_blank rel=noopener>参考</a></p><img src=https://img-blog.csdn.net/20180503220356422 alt=img style=zoom:150%><h2 id=实现>实现</h2><p><a class=link href="https://www.pjsip.org/pjnath/docs/html/index.htm?spm=a2c4e.10696291.0.0.4d9919a4qR66yE" target=_blank rel=noopener>PJNATH</a></p><h2 id=其它>其它</h2><p>UDP的协议进行数据传输穿透NAT的成功率比较高，接近100%。</p><p>TCP则存在一些情况无法实现穿越，主要受限路由器的端口映射机制。</p><p>要实现NAT穿越，需要有穿越控制服务器部署在互联网（有固定的域名或者IP），由该服务器来协助网络摄像机和客户端来实现NAT穿越。</p><p>有些服务器还能在TCP不能穿越的情况下，实现RELAY(数据中继转发)的功能，以确保二者之间能实现数据通信。</p><p>最后笔者给出几个技术方案的建议，有兴趣的朋友可以自己再去做深入研究，欢迎探讨。</p><ol><li><p>NAT穿越库的选择，笔者推荐PJSIP，网路摄像机以及客户端都可以采用。</p></li><li><p>NAT穿越控制服务器的选择，笔者推荐OPENSIPS。</p></li><li><p>可靠UDP传输方案的选择，推荐UDT。</p></li></ol><h2 id=参考>参考</h2><p><a class=link href=https://zh.wikipedia.org/wiki/NAT%E7%A9%BF%E9%80%8F target=_blank rel=noopener>Wiki</a></p></section><footer class=article-footer><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><div id=cusdis_thread data-host=https://cusdis.com data-app-id=287ed0fd-6a12-4302-a1ad-d2fd382e1199 data-page-id=0f58dc446cf75bad4d8e625055f0acdd data-page-url=https://blog.ververv.com/p/nat%E7%A9%BF%E9%80%8F/ data-page-title=NAT穿透></div><script async defer src=https://cusdis.com/js/cusdis.es.js></script><script>function setCusdisTheme(e){let t=document.querySelector("#cusdis_thread iframe");t&&window.CUSDIS.setTheme(e)}window.addEventListener("onColorSchemeChange",e=>{setCusdisTheme(e.detail)})</script><footer class=site-footer><section class=copyright>&copy;
2023 -
2024 量子跳跃者</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.24.2>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>